<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Hildegard von Bingen N=1 Clinical Trial</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="" />
    <script src="https://sheetdb.io/api/js"></script>
    <script src=" https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js "></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"
      integrity="sha256-8BDDxChCyYOB80/6VhOpmr7qI5EIDyDPzxsWePPFVfo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"
      integrity="sha256-UDxwmAK+KFxnav4Dab9fcgZtCwwjkpGIwxWPNcAyepw="
      crossorigin="anonymous"
    ></script>
    <style>
      .lineChart {
        position: relative;
        height: 40vh;
        width: 80vw;
      }
      .controls {
        display: flex;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div>
      <!-- <button onClick="refreshData()">Refresh</button> ; discarded in favor of #refresh URL -->
      <h1>Hildegard of Bingen N=1 Clinical Trial (2023-2024)</h1>
      <div id="medicalEvents"></div>
      <div id="allCharts"></div>
    </div>
    <script src="sheetData.js"></script>
    <script>
      if(typeof sheetData == "undefined") {
        alert("Missing sheetData, sheetData.js most probably could not load!");
        var sheetData = [];
      }
      function refreshData() {
        SheetDB.read("https://sheetdb.io/api/v1/xggkxm7zt5v0t", {
          sheet: "SEROLOGYRAW",
          limit: 0,
        }).then(
          function (result) {
            sheetData = result;
            console.log(sheetData);
            drawAllCharts();
          },
          function (error) {
            console.log(error);
          }
        );
      }

      var medicalEvents = [
        {
          date: "5/23/2012",
          name: "Right orchidectomy",
        },
        {
          date: "5/14/2020",
          name: "Partial left orchidectomy",
        },
      ];

      var normals = {
        "AFP (ng/mL)": { bounds: [["<", 10]], unit: "ng/mL" },
        "HCG intact (alpha+beta) (mUI/mL)": {
          bounds: [["<", 2.7]],
          unit: "mUI/mL",
        },
        "LDH (UI/L)": {
          bounds: [["<", 246]],
          unit: "UI/L",
        },
        "FSH (UI/L)": {
          bounds: [["<", 19.3]],
          unit: "UI/L",
        },
        "LH (UI/L)": {
          bounds: [["<", 8.6]],
          unit: "UI/L",
        },
        "bHCG (ng/mL)": {
          bounds: [["<", 0.1]],
          unit: "UI/L",
        },
        "Testosterone (ng/mL)": {
          bounds: [
            [">", 2.5],
            ["<", 10],
          ],
          unit: "UI/L",
        }, // https://www.lab-cerba.com/files/live/sites/Cerba/files/documents/FR/0489F.pdf
        "Cholesterol (mmol/L)": {
          bounds: [["<", 5.17]],
          unit: "UI/L",
        }, // https://www.uptodate.com/contents/high-cholesterol-and-lipids-beyond-the-basics/print
      };

      Chart.register(ChartDataLabels);

      const zoomOptions = {
        pan: {
          enabled: true,
          mode: "xy",
          modifierKey: "ctrl",
        },
        zoom: {
          mode: "xy",
          drag: {
            enabled: true,
            borderColor: "rgb(54, 162, 235)",
            borderWidth: 1,
            backgroundColor: "rgba(54, 162, 235, 0.3)",
          },
        },
      };

      var chartObjects = [];

      function drawChart(markerName) {
        console.log("drawing" + markerName);
        var chartData = {
          labels: sheetData.map(function (value) {
            return value.Date;
          }),
          datasets: [
            {
              label: markerName,
              fillColor: "transparent", //"#79D1CF",
              strokeColor: "#79D1CF",
              data: sheetData.map(function (value) {
                let i = value[markerName];
                return i == "" ? null : i;
              }),
            },
          ],
        };
        var newCanvas = document.createElement("canvas");
        newCanvas.id = markerName;
        newCanvas.className = "lineChart";
        document.getElementById("allCharts").appendChild(newCanvas);
        var ctx = newCanvas.getContext("2d");
        var allGraphAnnotations = {};
        // Draw blood marker normal value horizontal line
        var annotationLineId = 0;
        normals[markerName].bounds.forEach(function (bound) {
          allGraphAnnotations["normalLine" + annotationLineId++] = {
            type: "line",
            yMin: bound[1],
            yMax: bound[1],
            label: {
              display: true,
              content:
                "Normal " + bound.join(" ") + " " + normals[markerName].unit,
            },
            borderColor: "rgb(255, 99, 132)",
            borderWidth: 2,
          };
        });
        // Draw medical event vertical line
        annotationLineId = 0;
        medicalEvents.forEach(function (medicalEvent) {
          allGraphAnnotations["medicalEventLine" + annotationLineId++] = {
            type: "line",
            drawTime: "afterDatasetsDraw",
            xMin: medicalEvent.date,
            xMax: medicalEvent.date,
            mode: "vertical",
            label: {
              display: true,
              content: medicalEvent.name,
              rotation: 90
            },
            borderColor: "rgb(99, 99, 132, 0.5)",
            borderWidth: 10,
          };
        });

        console.log(allGraphAnnotations);
        // Draw graph for the current blood marker, with medical events and normal bars
        var newChart = new Chart(ctx, {
          plugins: [ChartDataLabels],
          type: "line",
          data: chartData,
          options: {
            spanGaps: false,
            showTooltips: true,
            responsive: true,
            plugins: {
              zoom: zoomOptions,
              datalabels: {
                color: "#202328",
                font: {
                  weight: "bold",
                },
                clamp: true,
                align: "top"
              },
              annotation: {
                annotations: allGraphAnnotations,
              },
            },
          },
        });
        chartObjects.push(newChart);
        var newControls = document.createElement("div");
        newControls.className = "controls";
        var newResetZoomButton = document.createElement("button");
        newResetZoomButton.innerHTML = "Reset zoom";
        newResetZoomButton.onclick = function () {
          newChart.resetZoom();
        };
        var newZoomDragHint = document.createElement("p");
        newZoomDragHint.innerText = "Drag to zoom, CTRL to pan.";
        newControls.appendChild(newResetZoomButton);
        newControls.appendChild(newZoomDragHint);
        newCanvas.after(newControls);
      }

      function drawAllCharts() {
        document.getElementById("allCharts").replaceChildren();
        while (chartObjects.length) {
          chartObjects.pop();
        }
        Object.keys(sheetData[0]).forEach(function (value) {
          if (!["Date", "Comment", "Laboratory"].includes(value)) {
            drawChart(value);
          }
        });
      }

      //drawChart("AFP (ng/mL)");
      drawAllCharts();

      if(window.location.hash == "#refresh") {
        refreshData();
      }
    </script>
  </body>
</html>
